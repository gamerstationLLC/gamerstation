name: Update LoL Patch Version (Blob)

on:
  schedule:
    # Midnight Eastern Time = 05:00 UTC (standard time). This runs daily at 05:00 UTC.
    - cron: "0 5 * * *"
  workflow_dispatch: {}

concurrency:
  group: lol-version-blob
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  version:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps
        run: npm ci

      - name: Fetch latest Data Dragon patch -> public/data/lol/version.json
        run: |
          set -euo pipefail
          mkdir -p public/data/lol

          # Latest is first element
          VERSION="$(curl -fsSL https://ddragon.leagueoflegends.com/api/versions.json | node -e 'const a=JSON.parse(require("fs").readFileSync(0,"utf8")); process.stdout.write(String(a?.[0] ?? ""))')"

          if [ -z "$VERSION" ]; then
            echo "Failed to fetch latest Data Dragon version."
            exit 1
          fi

          echo "{\"version\":\"$VERSION\"}" > public/data/lol/version.json
          echo "Wrote public/data/lol/version.json => $VERSION"

      - name: Upload version.json to Blob (overwrite)
        env:
          BLOB_READ_WRITE_TOKEN: ${{ secrets.BLOB_READ_WRITE_TOKEN }}
          BLOB_CACHE_SECONDS: "300"
          BLOB_FORCE_OVERWRITE: "1"
          # IMPORTANT: format is LOCAL=DEST (your upload script parses localRel on the left)
          BLOB_UPLOADS: "public/data/lol/version.json=data/lol/version.json"
        run: |
          set +e
          if [ -z "${BLOB_READ_WRITE_TOKEN:-}" ]; then
            echo "Missing BLOB_READ_WRITE_TOKEN secret; skipping upload."
            exit 0
          fi

          node scripts/blob/upload-data.mjs || true
          exit 0
