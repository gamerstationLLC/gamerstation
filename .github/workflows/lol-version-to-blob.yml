name: Update LoL Patch Version (Blob)

on:
  schedule:
    # Every 6 hours
    - cron: "0 */6 * * *"
  workflow_dispatch: {}

concurrency:
  group: lol-version-blob
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  version:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps
        run: npm ci

      - name: Write SR realm patch/version -> public/data/lol/version.json
        run: |
          set -euo pipefail
          node scripts/lol/write-version-json.mjs
          echo "-----"
          cat public/data/lol/version.json

      - name: Sanity check version.json (avoid uploading unknown)
        run: |
          set -euo pipefail
          node - <<'NODE'
          const fs = require("fs");
          const j = JSON.parse(fs.readFileSync("public/data/lol/version.json","utf8"));
          const patch = String(j.patch || "").trim();
          const dd = String(j.ddragon || j.version || "").trim();
          if (!patch || patch === "unknown" || patch === "—") {
            console.error("Refusing to upload: patch is missing/unknown:", patch);
            process.exit(1);
          }
          if (!dd || dd === "unknown" || dd === "—") {
            console.error("Refusing to upload: ddragon/version is missing/unknown:", dd);
            process.exit(1);
          }
          console.log("Sanity OK:", { patch, dd });
          NODE

      - name: Upload version.json to Blob (overwrite)
        env:
          BLOB_READ_WRITE_TOKEN: ${{ secrets.BLOB_READ_WRITE_TOKEN }}
          BLOB_CACHE_SECONDS: "300"
          BLOB_FORCE_OVERWRITE: "1"
          # IMPORTANT: format is LOCAL=DEST
          BLOB_UPLOADS: "public/data/lol/version.json=data/lol/version.json"
        run: |
          set +e
          if [ -z "${BLOB_READ_WRITE_TOKEN:-}" ]; then
            echo "Missing BLOB_READ_WRITE_TOKEN secret; skipping upload."
            exit 0
          fi

          node scripts/blob/upload-data.mjs || true
          exit 0
