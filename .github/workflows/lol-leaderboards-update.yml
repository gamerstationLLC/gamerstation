name: Update LoL Leaderboards

on:
  schedule:
    - cron: "0 */3 * * *" # every 3 hours
  workflow_dispatch: {}

concurrency:
  group: lol-leaderboards-update
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  leaderboards:
    runs-on: ubuntu-latest
    timeout-minutes: 240

    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # ✅ Always start from latest origin/main
      - name: Sync with main (pre-build)
        run: |
          set -e
          git fetch origin main
          git checkout main
          git reset --hard origin/main

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps
        run: npm ci

      # Build (never fail job)
      - name: Build LoL leaderboards (never fails job)
        env:
          RIOT_API_KEY: ${{ secrets.RIOT_API_KEY }}
          LEADERBOARD_TOP_N: "50"
          LEADERBOARD_CONCURRENCY: "3"
          LEADERBOARD_GAP_MS: "300"
          LEADERBOARD_MATCH_IDS_COUNT: "2"
          LEADERBOARD_REQ_MIN_GAP_MS: "250"
        run: |
          set +e
          npm run lol:leaderboards
          EC=$?
          echo "Build exit code: $EC"
          echo "Continuing to finalize regardless..."
          exit 0

      # Finalize (never fail job)
      - name: Finalize LoL leaderboards (never fails job)
        if: always()
        env:
          RIOT_API_KEY: ${{ secrets.RIOT_API_KEY }}
          LEADERBOARD_FINALIZE_CONCURRENCY: "2"
          LEADERBOARD_FINALIZE_REQ_MIN_GAP_MS: "200"
          LEADERBOARD_FINALIZE_GAP_MS: "200"
        run: |
          set +e
          npm run lol:finalize:leaderboards
          EC=$?
          echo "Finalize exit code: $EC"
          echo "Continuing to upload regardless..."
          exit 0

      - name: Debug - Output + git diff
        if: always()
        run: |
          echo "== Output sample =="
          ls -lah public/data/lol || true
          ls -lah public/data/lol/leaderboards || true
          find public/data/lol/leaderboards -maxdepth 3 -type f -name "*.json" | head -n 20 || true

          echo "== Git status (leaderboards) =="
          git status --porcelain -- public/data/lol/leaderboards || true

          echo "== Diffstat (leaderboards) =="
          git diff --stat -- public/data/lol/leaderboards || true

      # ✅ CRITICAL: prove what disk has *right now* (this is where the truth is)
      - name: Debug - Print generatedAt for key files (disk)
        if: always()
        run: |
          set +e
          echo "== generatedAt check (disk) =="

          node - <<'NODE'
          const fs = require("fs");

          const files = [
            "public/data/lol/leaderboards/na1/RANKED_SOLO_5x5.challenger.json",
            "public/data/lol/leaderboards/na1/RANKED_SOLO_5x5.grandmaster.json",
            "public/data/lol/leaderboards/na1/RANKED_SOLO_5x5.master.json",
          ];

          for (const f of files) {
            try {
              const raw = fs.readFileSync(f, "utf8");
              const j = JSON.parse(raw);
              console.log(`${f}`);
              console.log(`  generatedAt: ${j.generatedAt ?? "MISSING"}`);
              console.log(`  region: ${j.region ?? "MISSING"} queue: ${j.queue ?? "MISSING"} tier: ${j.tier ?? "MISSING"} count: ${j.count ?? "MISSING"}`);
              console.log("");
            } catch (e) {
              console.log(`${f}`);
              console.log(`  ERROR: ${e?.message ?? e}`);
              console.log("");
            }
          }
          NODE

          exit 0

      - name: Upload leaderboards to Vercel Blob (only if dataset is valid; never fails job)
        if: always()
        env:
          BLOB_READ_WRITE_TOKEN: ${{ secrets.BLOB_READ_WRITE_TOKEN }}
          BLOB_CACHE_SECONDS: "300"
        run: |
          set +e

          if [ -z "$BLOB_READ_WRITE_TOKEN" ]; then
            echo "BLOB_READ_WRITE_TOKEN missing in GitHub Secrets. Skipping Blob upload."
            exit 0
          fi

          if [ ! -d "public/data/lol/leaderboards" ]; then
            echo "No leaderboards directory exists; skipping upload."
            exit 0
          fi

          JSON_COUNT=$(find public/data/lol/leaderboards -type f -name "*.json" | wc -l | tr -d ' ')
          echo "Found $JSON_COUNT leaderboard json files."

          if [ "$JSON_COUNT" -lt 5 ]; then
            echo "Only $JSON_COUNT json files found — dataset incomplete. Skipping upload."
            exit 0
          fi

          MAX_FILES=800
          if [ "$JSON_COUNT" -gt "$MAX_FILES" ]; then
            echo "Too many files ($JSON_COUNT). Cap is $MAX_FILES to avoid env-size issues. Skipping upload."
            exit 0
          fi

          SPEC=""
          while IFS= read -r file; do
            rel="$file"
            blob="data/lol/leaderboards/${rel#public/data/lol/leaderboards/}"

            if [ -z "$SPEC" ]; then
              SPEC="${rel}=${blob}"
            else
              SPEC="${SPEC};${rel}=${blob}"
            fi
          done < <(find public/data/lol/leaderboards -type f -name "*.json" | sort)

          export BLOB_UPLOADS="$SPEC"

          node scripts/blob/upload-data.mjs
          EC=$?
          echo "Blob upload exit code: $EC"
          echo "Continuing regardless..."
          exit 0

      # ✅ AFTER upload: fetch the blob and print what it is serving *right now*
      - name: Debug - Verify Blob serves expected generatedAt (na1 solo challenger)
        if: always()
        run: |
          set +e
          echo "== blob verify (na1 solo challenger) =="

          node - <<'NODE'
          const url = "https://or3vgdqybw6oou7j.public.blob.vercel-storage.com/data/lol/leaderboards/na1/RANKED_SOLO_5x5.challenger.json";
          fetch(url, { cache: "no-store" })
            .then(r => r.text().then(t => ({ ok: r.ok, status: r.status, text: t })))
            .then(({ ok, status, text }) => {
              console.log("url:", url);
              console.log("status:", status, "ok:", ok);
              try {
                const j = JSON.parse(text);
                console.log("generatedAt:", j.generatedAt ?? "MISSING");
                console.log("region:", j.region, "queue:", j.queue, "tier:", j.tier, "count:", j.count);
              } catch (e) {
                console.log("FAILED to parse JSON:", e?.message ?? e);
                console.log("body head:", text.slice(0, 200));
              }
            })
            .catch(e => {
              console.log("FETCH ERROR:", e?.message ?? e);
            });
          NODE

          exit 0
