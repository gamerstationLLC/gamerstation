name: Update LoL Spells Overrides (Generate + Blob)

on:
  schedule:
    - cron: "0 */8 * * *" # every 8 hours
  workflow_dispatch:

jobs:
  spells-overrides:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout latest main
        run: |
          git fetch origin main
          git checkout main
          git reset --hard origin/main

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: npm ci

      # 1) Snapshot existing file (if it exists), run generator, then detect change
      - name: Generate spells_overrides.json and detect changes
        id: gen
        run: |
          set -e

          OUT="public/data/lol/spells_overrides.json"
          TMP="/tmp/spells_overrides.prev.json"

          mkdir -p "$(dirname "$OUT")"

          if [ -f "$OUT" ]; then
            cp "$OUT" "$TMP"
          else
            echo "{}" > "$TMP"
          fi

          node scripts/gen_spells_overrides.mjs

          # If generator didnâ€™t produce the file, fail (this is a real bug)
          if [ ! -f "$OUT" ]; then
            echo "Generator did not write $OUT"
            exit 1
          fi

          if cmp -s "$TMP" "$OUT"; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No changes detected."
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "Changes detected."
          fi

      # 2) Upload ONLY if changed
      - name: Upload spells_overrides.json to Blob
        if: steps.gen.outputs.changed == 'true'
        continue-on-error: true
        env:
          BLOB_READ_WRITE_TOKEN: ${{ secrets.BLOB_READ_WRITE_TOKEN }}
        run: |
          node scripts/blob/upload-spells-overrides.mjs
