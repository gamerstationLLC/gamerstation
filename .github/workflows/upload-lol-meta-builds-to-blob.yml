name: Upload LoL Meta Builds to Blob (from cache)

on:
  workflow_dispatch:
    inputs:
      force_overwrite:
        description: "Overwrite canonical blob keys"
        required: false
        default: "true"
      cache_seconds:
        description: "Blob cache seconds"
        required: false
        default: "300"

concurrency:
  group: upload-lol-meta-builds-from-cache
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  upload:
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps
        run: npm ci

      # ✅ Restore the same cache your main LoL workflow compounding uses
      - name: Restore Riot cache
        uses: actions/cache@v4
        with:
          path: |
            scripts/riot/cache/matches
            scripts/riot/cache/timelines
            scripts/riot/cache/state
          key: lol-riot-cache-v1-${{ runner.os }}
          restore-keys: |
            lol-riot-cache-v1-${{ runner.os }}
            lol-riot-cache-v1

      # Optional alignment with main pipeline (kept, but no crawling)
      - name: Update LoL static data
        run: npm run lol:update

      - name: Update LoL overrides
        run: npm run lol:update:overrides

      # ✅ Rebuild meta outputs FROM CACHE
      - name: Finalize meta builds (from restored cache)
        run: |
          set -e
          npm run lol:finalize:meta

      - name: Sanity check generatedAt + files exist
        run: |
          set -e
          test -f public/data/lol/meta_builds_ranked.json
          test -f public/data/lol/meta_builds_casual.json

          echo "Ranked generatedAt:"
          node -e "console.log(JSON.parse(require('fs').readFileSync('public/data/lol/meta_builds_ranked.json','utf8')).generatedAt)"
          echo "Casual generatedAt:"
          node -e "console.log(JSON.parse(require('fs').readFileSync('public/data/lol/meta_builds_casual.json','utf8')).generatedAt)"

      - name: Upload meta builds to Blob
        env:
          BLOB_READ_WRITE_TOKEN: ${{ secrets.BLOB_READ_WRITE_TOKEN }}
          # left = local file, right = blob key
          BLOB_UPLOADS: "public/data/lol/meta_builds_ranked.json=data/lol/meta_builds_ranked.json;public/data/lol/meta_builds_casual.json=data/lol/meta_builds_casual.json"
          BLOB_CACHE_SECONDS: ${{ inputs.cache_seconds }}
          BLOB_FORCE_OVERWRITE: ${{ inputs.force_overwrite == 'true' && '1' || '0' }}
          LOL_PATCH: manual-${{ github.run_id }}
        run: |
          set -e
          node scripts/blob/upload-data.mjs

      - name: Print test URLs (cache-busted)
        run: |
          echo "Ranked:"
          echo "https://or3vgdqybw6oou7j.public.blob.vercel-storage.com/data/lol/meta_builds_ranked.json?t=${{ github.run_id }}"
          echo ""
          echo "Casual:"
          echo "https://or3vgdqybw6oou7j.public.blob.vercel-storage.com/data/lol/meta_builds_casual.json?t=${{ github.run_id }}"